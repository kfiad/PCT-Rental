<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Management Dashboard</title>
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* A little extra style for smooth transitions */
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
     <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-gray-100">

    <!-- The main container where the app will be rendered by JavaScript -->
    <div id="app">
        <!-- App content will be dynamically inserted here -->
    </div>

    <!-- 2. Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- 3. All the application logic -->
    <script>
        // --- 1. INITIALIZE SUPABASE ---
        const supabaseUrl = 'https://yhxihrdpslvsneqbpzrp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InloeGlocmRwc2x2c25lcWJwenJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NjU2MzcsImV4cCI6MjA3MzA0MTYzN30._8LGgSwPJPkGd8AAVgNIfgN_e0rSfI7GfZKR9tXr_dg';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // --- APPLICATION STATE ---
        const state = {
            isLoading: true,
            user: null,
            authView: 'login',
            activeTab: 'dashboard',
            selectedTenantId: null,
            activePropertyId: null,
            properties: [],
            tenants: [],
            maintenanceRequests: [],
            tenantSearchTerm: '', // NEW: For the search bar
        };

        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        // --- CORE RENDER FUNCTION ---
        function render() {
            const appContainer = document.getElementById('app');
            if (!appContainer) return;

            if (state.isLoading) {
                appContainer.innerHTML = `<div class="min-h-screen flex justify-center items-center"><h1 class="text-2xl font-bold text-gray-800">Loading...</h1></div>`;
                return;
            }

            if (!state.user) {
                appContainer.innerHTML = renderAuth();
                return;
            }
            
            if (!state.activePropertyId && state.properties.length > 0) {
                 state.activePropertyId = state.properties[0].id;
            }
            
            if (state.properties.length === 0) {
                let content = `<div class="min-h-screen flex justify-center items-center"><div class="text-center"><h1 class="text-2xl font-bold text-gray-800">No Properties Found</h1><p class="text-gray-600">Add your first property in the 'Settings' tab.</p></div></div>`;
                const header = renderHeader(null, [], state.activeTab);
                appContainer.innerHTML = header + content;
                if (state.activeTab === 'settings') {
                    appContainer.innerHTML = header + `<main class="container mx-auto px-6 py-8 fade-in">${renderSettings([])}</main>`;
                }
                return;
            }

            const activeProperty = state.properties.find(p => p.id === state.activePropertyId);
            const activeTenants = state.tenants.filter(t => t.propertyId === state.activePropertyId);
            const activeMaintenanceRequests = state.maintenanceRequests.filter(m => m.propertyId === state.activePropertyId);

            let content = '';
            if (state.selectedTenantId) {
                const tenant = state.tenants.find(t => t.id === state.selectedTenantId);
                content = renderTenantProfile(tenant, activeProperty);
            } else {
                switch (state.activeTab) {
                    case 'dashboard': content = renderDashboard(activeTenants, activeMaintenanceRequests, months, activeProperty); break;
                    case 'tenants': content = renderTenants(activeTenants); break;
                    case 'accounts': content = renderAccounts(activeTenants, months, activeProperty); break;
                    case 'maintenance': content = renderMaintenance(activeMaintenanceRequests, activeTenants); break;
                    case 'settings': content = renderSettings(state.properties); break;
                    default: content = `<h2>Page not found</h2>`;
                }
            }
            
            appContainer.innerHTML = `
                ${renderHeader(activeProperty, state.properties, state.activeTab)}
                <main class="container mx-auto px-6 py-8 fade-in">
                    ${content}
                </main>
            `;
        }

        // --- AUTHENTICATION RENDER FUNCTION ---
        function renderAuth() {
            const isLoginView = state.authView === 'login';
            return `
                <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
                    <div class="max-w-md w-full space-y-8">
                        <div>
                            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                                ${isLoginView ? 'Sign in to your account' : 'Create a new account'}
                            </h2>
                        </div>
                        <form class="mt-8 space-y-6" data-action="${isLoginView ? 'login' : 'signup'}">
                            <div class="rounded-md shadow-sm -space-y-px">
                                <div>
                                    <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Email address">
                                </div>
                                <div>
                                    <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Password">
                                </div>
                            </div>
                            <div>
                                <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    ${isLoginView ? 'Sign in' : 'Sign up'}
                                </button>
                            </div>
                        </form>
                        <div class="text-sm text-center">
                            <a href="#" data-action="toggle-auth-view" class="font-medium text-indigo-600 hover:text-indigo-500">
                                ${isLoginView ? 'Don\'t have an account? Sign up' : 'Already have an account? Sign in'}
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- "COMPONENT" RENDER FUNCTIONS ---
        function renderHeader(activeProperty, allProperties, activeTab) {
            const navItems = ['dashboard', 'tenants', 'accounts', 'maintenance', 'settings'];
            const propertyOptions = allProperties.map(p => `<option value="${p.id}" ${activeProperty && p.id === activeProperty.id ? 'selected' : ''}>${p.name}</option>`).join('');
            
            return `
                <header class="bg-white shadow-md">
                    <div class="container mx-auto px-6 py-4 flex justify-between items-center flex-wrap gap-4">
                        <div class="flex items-center gap-4">
                            <h1 class="text-2xl font-bold text-gray-800">${activeProperty ? activeProperty.name : 'Property Manager'}</h1>
                            ${allProperties.length > 1 ? `
                                <select data-action="change-property" class="p-2 border rounded-md bg-gray-50 text-sm">
                                    ${propertyOptions}
                                </select>
                            ` : ''}
                        </div>
                        <nav>
                            ${navItems.map(item => `
                                <button data-action="navigate" data-tab="${item}" class="px-4 py-2 capitalize ${activeTab === item ? 'text-blue-600 font-semibold' : 'text-gray-600'}">
                                    ${item}
                                </button>
                            `).join('')}
                        </nav>
                    </div>
                </header>
            `;
        }
        
        function renderDashboard(tenants, maintenanceRequests, months, settings) {
             if (!settings) return `<p>Loading dashboard...</p>`;
             const today = new Date();
             const currentMonthIndex = today.getMonth();
             const currentMonthName = months[currentMonthIndex];

             const totalTenants = tenants.length;
             const totalUnits = settings.totalUnits;
             const occupancyRate = totalUnits > 0 ? ((totalTenants / totalUnits) * 100).toFixed(1) : 0;
             const pendingMaintenance = maintenanceRequests.filter(r => r.status === 'Pending').length;
             
             const currentMonthPaid = tenants.reduce((sum, t) => {
                const payment = t.payments[currentMonthIndex];
                return sum + (payment?.status === 'Paid' ? payment.amount : 0);
             }, 0);
             const currentMonthDue = tenants.reduce((sum, t) => {
                const payment = t.payments[currentMonthIndex];
                return sum + (payment?.status === 'Due' ? payment.amount : 0);
             }, 0);
             const currentMonthTotal = currentMonthPaid + currentMonthDue;

            return `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-gray-700">Total Rent (${currentMonthName})</h3><p class="text-4xl font-bold text-blue-600 mt-2">${currentMonthTotal.toLocaleString()} ${settings.currency}</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-gray-700">Paid (${currentMonthName})</h3><p class="text-4xl font-bold text-green-600 mt-2">${currentMonthPaid.toLocaleString()} ${settings.currency}</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-gray-700">Due (${currentMonthName})</h3><p class="text-4xl font-bold text-red-600 mt-2">${currentMonthDue.toLocaleString()} ${settings.currency}</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-gray-700">Total Tenants</h3><p class="text-4xl font-bold text-gray-700 mt-2">${totalTenants}</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-gray-700">Occupancy</h3><p class="text-4xl font-bold text-gray-700 mt-2">${occupancyRate}%</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-gray-700">Maintenance</h3><p class="text-4xl font-bold text-yellow-600 mt-2">${pendingMaintenance}</p></div>
                </div>
            `;
        }
        
        function renderTenants(allTenants) {
            // NEW: Filter tenants based on the search term
            const filteredTenants = allTenants.filter(tenant => {
                const searchTerm = state.tenantSearchTerm.toLowerCase();
                return tenant.name.toLowerCase().includes(searchTerm) || tenant.unit.toLowerCase().includes(searchTerm);
            });

            const shops = filteredTenants.filter(t => t.type === 'Shop');
            const offices = filteredTenants.filter(t => t.type === 'Office');
            
            const tenantCard = (tenant) => `
                <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow duration-300 flex flex-col justify-between">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">${tenant.name}</h3>
                        <p class="text-gray-600">Unit ${tenant.unit}</p>
                    </div>
                    <div class="mt-4">
                        <button data-action="view-tenant" data-tenant-id="${tenant.id}" class="px-4 py-2 rounded-md font-semibold text-white transition-colors duration-300 text-sm bg-blue-600 hover:bg-blue-700">View Profile</button>
                    </div>
                </div>
            `;

            return `
                 <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-gray-800">Tenants</h2>
                    <div class="flex items-center gap-2">
                        <!-- NEW: Search Bar -->
                        <input type="text" data-action="search-tenants" value="${state.tenantSearchTerm}" placeholder="Search by name or unit..." class="p-2 border rounded-md w-full md:w-auto">
                        <button data-action="open-modal" data-modal="add-tenant" class="px-4 py-2 rounded-md font-semibold text-white transition-colors duration-300 text-sm bg-blue-600 hover:bg-blue-700 flex-shrink-0">Add Tenant</button>
                    </div>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4">Shops</h3>
                    ${shops.length > 0 ? `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${shops.map(tenantCard).join('')}</div>` : `<p class="text-gray-500">No matching shop tenants found.</p>`}
                </div>
                <div>
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4">Offices</h3>
                     ${offices.length > 0 ? `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${offices.map(tenantCard).join('')}</div>` : `<p class="text-gray-500">No matching office tenants found.</p>`}
                </div>
                ${renderAddTenantModal()}
            `;
        }

        function renderTenantProfile(tenant, settings) {
            if (!tenant || !settings) return `<p class="text-center text-gray-600">Could not find details. Please go back.</p>`;
            return `
                <div class="flex justify-between items-start mb-6 flex-wrap gap-2">
                    <button data-action="back-to-tenants" class="px-4 py-2 rounded-md font-semibold text-white transition-colors duration-300 text-sm bg-gray-500 hover:bg-gray-600">Back to Tenants</button>
                    <div class="flex gap-2">
                        <button data-action="open-modal" data-modal="edit-tenant" data-tenant-id="${tenant.id}" class="px-4 py-2 rounded-md font-semibold text-white transition-colors duration-300 text-sm bg-blue-600 hover:bg-blue-700">Edit Tenant</button>
                        <!-- NEW: Delete Tenant Button -->
                        <button data-action="delete-tenant" data-tenant-id="${tenant.id}" class="px-4 py-2 rounded-md font-semibold text-white transition-colors duration-300 text-sm bg-red-600 hover:bg-red-700">Delete Tenant</button>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                     <h2 class="text-3xl font-bold text-gray-800 mb-4">${tenant.name}</h2>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div>
                            <h3 class="text-xl font-semibold text-gray-700 mb-2">Personal Information</h3>
                            <p><strong>NID:</strong> ${tenant.nid}</p><p><strong>Contact:</strong> ${tenant.contact}</p><p><strong>Unit:</strong> ${tenant.unit} (${tenant.type})</p>
                         </div>
                         <div>
                            <h3 class="text-xl font-semibold text-gray-700 mb-2">Legal Information</h3>
                            <p><strong>Deed End Date:</strong> ${tenant.deedEnd}</p><p><strong>Advance Paid:</strong> ${tenant.advance.toLocaleString()} ${settings.currency}</p>
                         </div>
                     </div>
                     <div class="mt-8">
                         <h3 class="text-xl font-semibold text-gray-700 mb-4">Monthly Payments</h3>
                         <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead><tr><th class="py-2 px-4">Month</th><th class="py-2 px-4">Amount</th><th class="py-2 px-4">Status</th><th class="py-2 px-4">Action</th></tr></thead>
                                <tbody>
                                ${tenant.payments.map(p => `
                                    <tr class="border-b">
                                        <td class="py-2 px-4">${p.month}</td>
                                        <td class="py-2 px-4">${p.amount.toLocaleString()} ${settings.currency}</td>
                                        <td class="py-2 px-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${p.status === 'Paid' ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">${p.status}</span></td>
                                        <td class="py-2 px-4">${p.status === 'Due' ? `<button data-action="mark-paid" data-tenant-id="${tenant.id}" data-month="${p.month}" class="px-4 py-2 rounded-md font-semibold text-white transition-colors duration-300 text-sm bg-green-600 hover:bg-green-700">Mark as Paid</button>` : ''}</td>
                                    </tr>
                                `).join('')}
                                </tbody>
                            </table>
                         </div>
                     </div>
                </div>
                ${renderEditTenantModal(tenant)}
            `;
        }
        
        function renderAccounts(tenants, months, settings) {
            if (!settings) return `<p>Loading accounts...</p>`;
            const shops = tenants.filter(t => t.type === 'Shop');
            const offices = tenants.filter(t => t.type === 'Office');

            const today = new Date();
            const currentMonthIndex = today.getMonth();
            const currentMonthName = months[currentMonthIndex];
            const monthlyIncome = tenants.reduce((sum, tenant) => sum + (tenant.payments[currentMonthIndex]?.status === 'Paid' ? tenant.payments[currentMonthIndex].amount : 0), 0);
            const yearlyIncome = tenants.reduce((sum, tenant) => sum + tenant.payments.reduce((ts, p) => ts + (p.status === 'Paid' ? p.amount : 0), 0), 0);
            const totalDues = tenants.reduce((sum, tenant) => sum + tenant.payments.reduce((ts, p) => ts + (p.status === 'Due' ? p.amount : 0), 0), 0);
            const totalAdvance = tenants.reduce((sum, tenant) => sum + Number(tenant.advance), 0);

            return `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Financial Accounts</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold text-gray-600">Income (${currentMonthName})</h3><p class="text-3xl font-bold text-blue-600 mt-2">${monthlyIncome.toLocaleString()} ${settings.currency}</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold text-gray-600">Total Yearly Income</h3><p class="text-3xl font-bold text-green-600 mt-2">${yearlyIncome.toLocaleString()} ${settings.currency}</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold text-gray-600">Total Dues</h3><p class="text-3xl font-bold text-red-600 mt-2">${totalDues.toLocaleString()} ${settings.currency}</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold text-gray-600">Total Advance Paid</h3><p class="text-3xl font-bold text-purple-600 mt-2">${totalAdvance.toLocaleString()} ${settings.currency}</p></div>
                </div>
                <div class="mb-8">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4">Shops</h3>
                    <div class="bg-white p-6 rounded-lg shadow-md">${renderAccountTable(shops, months)}</div>
                </div>
                <div>
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4">Offices</h3>
                    <div class="bg-white p-6 rounded-lg shadow-md">${renderAccountTable(offices, months)}</div>
                </div>
            `;
        }

        function renderAccountTable(tenants, months) {
            return `
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b">
                                <th class="py-2 px-2">Tenant</th><th class="py-2 px-2">Unit</th>
                                ${months.map(m => `<th key="${m}" class="py-2 px-2 text-right">${m.slice(0,3)}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${tenants.map(tenant => `
                                <tr class="border-b hover:bg-gray-50 group">
                                    <td class="py-2 px-2 font-medium">${tenant.name}</td><td class="py-2 px-2 text-sm text-gray-600">${tenant.unit}</td>
                                    ${tenant.payments.map(p => `
                                        <td class="py-2 px-2 text-right text-sm transition-colors duration-200 ${p.status === 'Due' ? 'text-transparent group-hover:text-red-500 font-semibold' : 'text-gray-800'}">
                                            ${p.amount.toLocaleString()}
                                        </td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderMaintenance(requests, tenants) {
            const statusTag = (status) => {
                const colors = {
                    'Pending': 'bg-yellow-200 text-yellow-800',
                    'In Progress': 'bg-blue-200 text-blue-800',
                    'Completed': 'bg-green-200 text-green-800',
                };
                return `<span class="px-2 py-1 text-xs font-semibold rounded-full ${colors[status] || ''}">${status}</span>`;
            };

            return `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Maintenance Requests</h2>
                    <button data-action="open-modal" data-modal="add-maintenance" class="px-4 py-2 rounded-md font-semibold text-white transition-colors duration-300 text-sm bg-blue-600 hover:bg-blue-700">Add Request</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <table class="w-full text-left">
                        <thead><tr class="border-b"><th class="py-2">Tenant</th><th class="py-2">Unit</th><th class="py-2">Issue</th><th class="py-2">Status</th></tr></thead>
                        <tbody>
                            ${requests.map(req => `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="py-3">${req.tenantName}</td>
                                    <td class="py-3">${req.unit}</td>
                                    <td class="py-3 max-w-sm">${req.issue}</td>
                                    <td class="py-3">${statusTag(req.status)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ${renderAddMaintenanceModal(tenants)}
            `;
        }

        function renderSettings(properties) {
            return `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Properties</h2>
                    <button data-action="open-property-modal" class="px-4 py-2 rounded-md font-semibold text-white transition-colors duration-300 text-sm bg-blue-600 hover:bg-blue-700">Add New Property</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <div class="space-y-4">
                        ${properties.map(prop => `
                            <div class="p-4 border rounded-md flex justify-between items-center">
                                <div>
                                    <h3 class="font-semibold text-lg">${prop.name}</h3>
                                    <p class="text-sm text-gray-600">${prop.totalUnits} units</p>
                                </div>
                                <div class="flex gap-2">
                                     <button data-action="open-property-modal" data-property-id="${prop.id}" class="px-4 py-2 rounded-md font-semibold text-white transition-colors duration-300 text-sm bg-gray-500 hover:bg-gray-600">Edit</button>
                                     <!-- NEW: Delete Property Button -->
                                     <button data-action="delete-property" data-property-id="${prop.id}" class="px-4 py-2 rounded-md font-semibold text-white transition-colors duration-300 text-sm bg-red-600 hover:bg-red-700">Delete</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div id="property-modal-container"></div>

                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4">Account</h3>
                    <p class="text-gray-600 mb-4">You are logged in as: <span class="font-medium text-gray-800">${state.user.email}</span></p>
                    <button data-action="logout" class="px-4 py-2 rounded-md font-semibold text-white transition-colors duration-300 text-sm bg-red-600 hover:bg-red-700">
                        Log Out
                    </button>
                </div>
            `;
        }
        
        function renderAddTenantModal() {
            return `
                <div id="add-tenant-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden">
                    <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg relative">
                        <button data-action="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                        <form data-action="add-tenant">
                            <h2 class="text-2xl font-bold mb-6">Add New Tenant</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input name="name" placeholder="Tenant Name" class="p-2 border rounded" required />
                                <input name="nid" placeholder="NID" class="p-2 border rounded" />
                                <input name="contact" placeholder="Contact No." class="p-2 border rounded" />
                                <input name="unit" placeholder="Unit No." class="p-2 border rounded" required />
                                <select name="type" class="p-2 border rounded"><option value="Shop">Shop</option><option value="Office">Office</option></select>
                                <input name="deedEnd" type="date" class="p-2 border rounded" />
                                <input name="advance" type="number" placeholder="Advance Amount" class="p-2 border rounded" />
                                <input name="rent" type="number" placeholder="Monthly Rent" class="p-2 border rounded" required />
                            </div>
                            <div class="mt-6 flex justify-end">
                                <button type="submit" class="px-4 py-2 rounded-md font-semibold text-white transition-colors duration-300 text-sm bg-blue-600 hover:bg-blue-700">Add Tenant</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        function renderEditTenantModal(tenant) {
            if (!tenant) return '';
            const rent = tenant.payments ? (tenant.payments.find(p => p.status === 'Due')?.amount || tenant.payments[0].amount) : 0;
            return `
                 <div id="edit-tenant-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden">
                    <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg relative">
                        <button data-action="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                        <form data-action="edit-tenant">
                            <input type="hidden" name="id" value="${tenant.id}" />
                            <h2 class="text-2xl font-bold mb-6">Edit Tenant</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input name="name" placeholder="Tenant Name" class="p-2 border rounded" required value="${tenant.name}" />
                                <input name="nid" placeholder="NID" class="p-2 border rounded" value="${tenant.nid}" />
                                <input name="contact" placeholder="Contact No." class="p-2 border rounded" value="${tenant.contact}" />
                                <input name="unit" placeholder="Unit No." class="p-2 border rounded" required value="${tenant.unit}" />
                                <select name="type" class="p-2 border rounded"><option selected value="${tenant.type}">${tenant.type}</option><option value="Shop">Shop</option><option value="Office">Office</option></select>
                                <input name="deedEnd" type="date" class="p-2 border rounded" value="${tenant.deedEnd}" />
                                <input name="advance" type="number" placeholder="Advance Amount" class="p-2 border rounded" value="${tenant.advance}" />
                                <input name="rent" type="number" placeholder="Monthly Rent" class="p-2 border rounded" required value="${rent}" />
                            </div>
                            <div class="mt-6 flex justify-end">
                                <button type="submit" class="px-4 py-2 rounded-md font-semibold text-white transition-colors duration-300 text-sm bg-blue-600 hover:bg-blue-700">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        function renderAddMaintenanceModal(tenants) {
            const tenantOptions = tenants.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
            return `
                <div id="add-maintenance-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden">
                    <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg relative">
                        <button data-action="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                        <form data-action="add-maintenance">
                            <h2 class="text-2xl font-bold mb-6">New Maintenance Request</h2>
                            <div class="space-y-4">
                                <select name="tenantName" class="w-full p-2 border rounded" required>
                                    <option value="">Select Tenant</option>
                                    ${tenantOptions}
                                </select>
                                <textarea name="issue" placeholder="Describe the issue" class="w-full p-2 border rounded" required></textarea>
                            </div>
                            <div class="mt-6 flex justify-end">
                                <button type="submit" class="px-4 py-2 rounded-md font-semibold text-white transition-colors duration-300 text-sm bg-blue-600 hover:bg-blue-700">Submit Request</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderPropertyFormModal(property = null) {
            const isEdit = property !== null;
            return `
                <div id="property-form-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg relative">
                        <button data-action="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                        <form data-action="save-property">
                            ${isEdit ? `<input type="hidden" name="id" value="${property.id}" />` : ''}
                            <h2 class="text-2xl font-bold mb-6">${isEdit ? 'Edit Property' : 'Add New Property'}</h2>
                            <div class="space-y-4">
                                <input name="name" placeholder="Property Name" class="p-2 w-full border rounded-md" required value="${isEdit ? property.name : ''}" />
                                <input name="ownerName" placeholder="Owner Name" class="p-2 w-full border rounded-md" value="${isEdit ? property.ownerName : ''}" />
                                <input name="totalUnits" type="number" placeholder="Total Units" class="p-2 w-full border rounded-md" required value="${isEdit ? property.totalUnits : ''}" />
                                <input name="currency" placeholder="Currency (e.g., BDT)" class="p-2 w-full border rounded-md" required value="${isEdit ? property.currency : 'BDT'}" />
                            </div>
                            <div class="mt-6 flex justify-end">
                                <button type="submit" class="px-4 py-2 rounded-md font-semibold text-white transition-colors duration-300 text-sm bg-blue-600 hover:bg-blue-700">${isEdit ? 'Save Changes' : 'Add Property'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        // --- EVENT HANDLERS & LOGIC (WITH AUTH) ---
        
        async function handleSignup(email, password) {
            const { error } = await supabaseClient.auth.signUp({ email, password });
            if (error) alert(error.message);
            else alert('Check your email for the confirmation link! (If you disabled email confirmation in Supabase, you can now log in).');
        }

        async function handleLogin(email, password) {
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) alert(error.message);
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            state.user = null;
            render();
        }

        function handleNavigation(tab) {
            state.activeTab = tab;
            state.selectedTenantId = null;
            render();
        }
        
        function handleViewTenant(tenantId) {
            state.selectedTenantId = tenantId;
            render();
        }

        async function handleMarkAsPaid(tenantId, month) {
            const tenant = state.tenants.find(t => t.id === tenantId);
            if(tenant) {
                const updatedPayments = tenant.payments.map(p => 
                    p.month === month ? { ...p, status: 'Paid' } : p
                );
                
                const { error } = await supabaseClient
                    .from('tenants')
                    .update({ payments: updatedPayments })
                    .eq('id', tenantId);

                if (error) console.error('Error updating payment:', error);
                else await fetchAllDataForCurrentUser();
            }
        }

        async function handleAddTenant(formData) {
            const newTenantData = {
                propertyId: state.activePropertyId,
                name: formData.get('name'),
                nid: formData.get('nid'),
                contact: formData.get('contact'),
                unit: formData.get('unit'),
                type: formData.get('type'),
                deedEnd: formData.get('deedEnd') || null,
                advance: Number(formData.get('advance')) || 0,
                payments: months.map(month => ({
                    month,
                    amount: Number(formData.get('rent')),
                    status: 'Due'
                })),
                user_id: state.user.id
            };
            const { error } = await supabaseClient.from('tenants').insert(newTenantData);
            if (error) {
                console.error('Error adding tenant:', error);
                alert('Error adding tenant: ' + error.message);
            }
            else {
                document.getElementById('add-tenant-modal').classList.add('hidden');
                await fetchAllDataForCurrentUser();
            }
        }

        async function handleEditTenant(formData) {
            const tenantId = Number(formData.get('id'));
            const tenant = state.tenants.find(t => t.id === tenantId);

            if (tenant) {
                const newRent = Number(formData.get('rent'));
                const updatedPayments = tenant.payments.map(p => {
                    if (p.status === 'Due') {
                        return { ...p, amount: newRent };
                    }
                    return p;
                });

                const updatedData = {
                    name: formData.get('name'),
                    nid: formData.get('nid'),
                    contact: formData.get('contact'),
                    unit: formData.get('unit'),
                    type: formData.get('type'),
                    deedEnd: formData.get('deedEnd') || null,
                    advance: Number(formData.get('advance')) || 0,
                    payments: updatedPayments,
                };

                const { error } = await supabaseClient.from('tenants').update(updatedData).eq('id', tenantId);
                if(error) console.error('Error updating tenant:', error);
                else {
                    document.getElementById('edit-tenant-modal').classList.add('hidden');
                    await fetchAllDataForCurrentUser();
                }
            }
        }

        async function handleAddMaintenance(formData) {
            const tenantName = formData.get('tenantName');
            const tenant = state.tenants.find(t => t.name === tenantName);
            const newRequestData = {
                propertyId: state.activePropertyId,
                tenantName: tenantName,
                unit: tenant ? tenant.unit : 'N/A',
                issue: formData.get('issue'),
                status: 'Pending',
                user_id: state.user.id
            };
            const { error } = await supabaseClient.from('maintenancerequests').insert(newRequestData);
            if (error) console.error('Error adding maintenance request:', error);
            else {
                document.getElementById('add-maintenance-modal').classList.add('hidden');
                await fetchAllDataForCurrentUser();
            }
        }

        async function handleSaveProperty(formData) {
            const propertyId = formData.get('id');
            const data = {
                name: formData.get('name'),
                ownerName: formData.get('ownerName'),
                totalUnits: Number(formData.get('totalUnits')),
                currency: formData.get('currency'),
                user_id: state.user.id
            };

            let error;
            if (propertyId) {
                ({ error } = await supabaseClient.from('properties').update(data).eq('id', propertyId));
            } else {
                ({ error } = await supabaseClient.from('properties').insert(data));
            }
            
            if(error) {
                console.error('Error saving property:', error);
                alert('Error saving property: ' + error.message);
            }
            else {
                 const modal = document.getElementById('property-form-modal');
                 if(modal) modal.remove();
                 await fetchAllDataForCurrentUser();
            }
        }

        // NEW: Delete Tenant Handler
        async function handleDeleteTenant(tenantId) {
            if (window.confirm('Are you sure you want to delete this tenant? This action cannot be undone.')) {
                const { error } = await supabaseClient.from('tenants').delete().eq('id', tenantId);
                if (error) {
                    console.error('Error deleting tenant:', error);
                    alert('Error deleting tenant: ' + error.message);
                } else {
                    state.selectedTenantId = null; // Go back to the tenants list
                    await fetchAllDataForCurrentUser();
                }
            }
        }

        // NEW: Delete Property Handler
        async function handleDeleteProperty(propertyId) {
             if (window.confirm('Are you sure you want to delete this property and all its tenants? This action cannot be undone.')) {
                // In a real app, you'd handle deleting related tenants first or have cascade deletes set up in the DB.
                // For this MVP, we assume tenants are deleted with the property via CASCADE constraint in SQL.
                const { error } = await supabaseClient.from('properties').delete().eq('id', propertyId);
                 if (error) {
                    console.error('Error deleting property:', error);
                    alert('Error deleting property: ' + error.message);
                } else {
                    await fetchAllDataForCurrentUser();
                }
            }
        }

        document.body.addEventListener('click', (e) => {
            let target = e.target.closest('[data-action]');
            if (!target) return;
            const action = target.dataset.action;

            if (action === 'toggle-auth-view') {
                e.preventDefault();
                state.authView = state.authView === 'login' ? 'signup' : 'login';
                render();
            }
            if (action === 'logout') handleLogout();
            if (action === 'navigate') handleNavigation(target.dataset.tab);
            if (action === 'view-tenant') handleViewTenant(Number(target.dataset.tenantId));
            if (action === 'back-to-tenants') { state.selectedTenantId = null; render(); }
            if (action === 'mark-paid') handleMarkAsPaid(Number(target.dataset.tenantId), target.dataset.month);
            if (action === 'delete-tenant') handleDeleteTenant(Number(target.dataset.tenantId));
            if (action === 'delete-property') handleDeleteProperty(Number(target.dataset.propertyId));
            if (action === 'open-modal') document.getElementById(`${target.dataset.modal}-modal`)?.classList.remove('hidden');
            if (action === 'open-property-modal') {
                const propertyId = target.dataset.propertyId ? Number(target.dataset.propertyId) : null;
                const property = propertyId ? state.properties.find(p => p.id === propertyId) : null;
                const modalContainer = document.getElementById('property-modal-container');
                if (modalContainer) modalContainer.innerHTML = renderPropertyFormModal(property);
            }
            if (action === 'close-modal') target.closest('.fixed')?.remove();
        });
        
        document.body.addEventListener('submit', (e) => {
             e.preventDefault();
             const action = e.target.dataset.action;
             if (!action) return;
             const formData = new FormData(e.target);
             const email = formData.get('email');
             const password = formData.get('password');

             if (action === 'login') handleLogin(email, password);
             if (action === 'signup') handleSignup(email, password);
             if (action === 'add-tenant') handleAddTenant(formData);
             if (action === 'edit-tenant') handleEditTenant(formData);
             if (action === 'add-maintenance') handleAddMaintenance(formData);
             if (action === 'save-property') handleSaveProperty(formData);
        });

        document.body.addEventListener('input', (e) => {
            let target = e.target.closest('[data-action]');
            if (!target) return;
            const action = target.dataset.action;

            if (action === 'search-tenants') {
                state.tenantSearchTerm = e.target.value;
                render();
            }
        });

        document.body.addEventListener('change', (e) => {
             const action = e.target.dataset.action;
             if (action === 'change-property') {
                state.activePropertyId = Number(e.target.value);
                render();
             }
        });
        
        // --- 4. APP INITIALIZATION & AUTH LISTENER ---
        
        async function fetchAllDataForCurrentUser() {
            if (!state.user) return;
            try {
                const { data: properties, error: propertiesError } = await supabaseClient.from('properties').select('*').eq('user_id', state.user.id);
                if (propertiesError) throw propertiesError;
                
                const { data: tenants, error: tenantsError } = await supabaseClient.from('tenants').select('*').eq('user_id', state.user.id);
                 if (tenantsError) throw tenantsError;

                const { data: maintenanceRequests, error: maintenanceError } = await supabaseClient.from('maintenancerequests').select('*').eq('user_id', state.user.id);
                 if (maintenanceError) throw maintenanceError;

                state.properties = properties;
                state.tenants = tenants;
                state.maintenanceRequests = maintenanceRequests;

                const activePropertyStillExists = properties.some(p => p.id === state.activePropertyId);
                if (!activePropertyStillExists && properties.length > 0) {
                    state.activePropertyId = properties[0].id;
                } else if (properties.length === 0) {
                    state.activePropertyId = null;
                }

                state.isLoading = false;
                render();
            } catch (error) {
                console.error("Error fetching data from Supabase:", error);
                 const appContainer = document.getElementById('app');
                appContainer.innerHTML = `<div class="min-h-screen flex justify-center items-center"><div class="text-center p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                    <h1 class="text-2xl font-bold">Supabase Data Error</h1>
                    <p class="mt-2">Could not fetch your data. Please check your Supabase Row Level Security (RLS) policies.</p>
                </div></div>`;
            }
        }

        supabaseClient.auth.onAuthStateChange((event, session) => {
            state.user = session ? session.user : null;
            state.isLoading = false;
            if (state.user) {
                fetchAllDataForCurrentUser();
            } else {
                render();
            }
        });
    </script>

</body>
</html>

